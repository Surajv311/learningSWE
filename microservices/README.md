## Microservices 

### FastAPI 

- FastAPI Overview: A modern, fast (high-performance) web framework for building APIs with Python 3.7+ based on standard Python type hints. 
- ASGI Framework: FastAPI is built on ASGI (Asynchronous Server Gateway Interface), allowing for async and await capabilities for handling asynchronous tasks.
- Dependencies, Path and Query Parameters, Pydantic Models
- Asynchronous Programming: FastAPI supports async functions, enabling handling of I/O-bound operations efficiently.
- Database Operations: Use async database libraries (e.g., databases, SQLAlchemy with async support) to interact with databases asynchronously.
- Custom Middleware: Add middleware for tasks such as logging, CORS handling, or authentication.
- ORM Integration: Use ORMs like SQLAlchemy, Tortoise ORM, or Pydanticâ€™s BaseModel for database operations.
- Use tools like pytest for unit and integration testing.
- Background Tasks: Execute background tasks asynchronously using BackgroundTasks.

### Docker

A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image. Below are the main components of a Dockerfile and explanations of when and how to use them:

#### Dockerfile Components

1. **FROM**
   - **Syntax:** `FROM <image>`
   - **Description:** Specifies the base image to use for the Docker image. This is the starting point for the build process.
   - **When to Use:** Always, as it defines the base layer for your image.
   - **Example:** `FROM python:3.9-slim`

2. **LABEL**
   - **Syntax:** `LABEL key=value`
   - **Description:** Adds metadata to an image. Useful for providing information such as maintainer details or a version number.
   - **When to Use:** When you want to include metadata in the image.
   - **Example:** `LABEL maintainer="you@example.com"`

3. **RUN**
   - **Syntax:** `RUN <command>`
   - **Description:** Executes a command in a new layer on top of the current image and commits the results. This is often used for installing packages.
   - **When to Use:** When you need to install dependencies or run commands required to build your application.
   - **Example:** `RUN apt-get update && apt-get install -y gcc`

4. **COPY and ADD**
   - **Syntax:**
     - `COPY <src> <dest>`
     - `ADD <src> <dest>`
   - **Description:** 
     - `COPY` copies files and directories from the host file system to the image.
     - `ADD` does the same as `COPY` but also supports extracting tar files and fetching files from URLs.
   - **When to Use:** Use `COPY` for simple copying and `ADD` for additional functionalities.
   - **Example:** `COPY . /app`

5. **WORKDIR**
   - **Syntax:** `WORKDIR /path/to/workdir`
   - **Description:** Sets the working directory for any subsequent `RUN`, `CMD`, `ENTRYPOINT`, `COPY`, and `ADD` instructions.
   - **When to Use:** When you want to set the working directory for your application.
   - **Example:** `WORKDIR /app`

6. **CMD**
   - **Syntax:** `CMD ["executable","param1","param2"]`
   - **Description:** Provides defaults for an executing container. There can only be one `CMD` instruction in a Dockerfile. If you provide multiple `CMD` instructions, only the last one will take effect.
   - **When to Use:** To specify the default command to run when the container starts.
   - **Example:** `CMD ["python", "app.py"]`

7. **ENTRYPOINT**
   - **Syntax:** `ENTRYPOINT ["executable", "param1", "param2"]`
   - **Description:** Configures a container that will run as an executable. It allows you to configure a container to run as if it were that executable.
   - **When to Use:** When you want to define a container with a specific executable.
   - **Example:** `ENTRYPOINT ["python"]`

8. **ENV**
   - **Syntax:** `ENV key=value`
   - **Description:** Sets environment variables.
   - **When to Use:** To define environment variables that will be available in your container.
   - **Example:** `ENV APP_ENV=production`

9. **EXPOSE**
   - **Syntax:** `EXPOSE <port>`
   - **Description:** Informs Docker that the container listens on the specified network ports at runtime. It does not actually publish the port.
   - **When to Use:** When your application runs on specific ports.
   - **Example:** `EXPOSE 80`

10. **VOLUME**
    - **Syntax:** `VOLUME ["/data"]`
    - **Description:** Creates a mount point with the specified path and marks it as holding externally mounted volumes from the native host or other containers.
    - **When to Use:** When you need to persist data generated by and used by Docker containers.
    - **Example:** `VOLUME ["/app/data"]`

11. **USER**
    - **Syntax:** `USER <username or UID>`
    - **Description:** Sets the username or UID to use when running the image and for any `RUN`, `CMD`, and `ENTRYPOINT` instructions that follow it in the Dockerfile.
    - **When to Use:** When you want to run the container as a non-root user for security reasons.
    - **Example:** `USER appuser`

12. **ONBUILD**
    - **Syntax:** `ONBUILD <instruction>`
    - **Description:** Adds a trigger instruction to the image that will be executed when the image is used as a base for another build.
    - **When to Use:** When you want to define actions that should be taken when the image is used as a base for another build.
    - **Example:** `ONBUILD COPY . /app/src`

#### Dockerfile Example

Here's an example Dockerfile that demonstrates the use of several components:

```dockerfile
# Use an official Python runtime as a parent image
FROM python:3.9-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Set the working directory
WORKDIR /app

# Copy the current directory contents into the container at /app
COPY . /app

# Install any needed packages specified in requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Make port 80 available to the world outside this container
EXPOSE 80

# Define environment variable
ENV NAME World

# Run app.py when the container launches
CMD ["python", "app.py"]
```

* Giving all necessary permissions to our new user which we use to create tables/db. 
  - postgresdockerlocal-# `grant all privileges on database fapidb to postgresdluser;`
  - postgresdockerlocal=# `GRANT CONNECT ON DATABASE fapidb TO postgresdluser;`
  - postgresdockerlocal=# `GRANT pg_read_all_data TO postgresdluser;`
  - postgresdockerlocal=# `GRANT pg_write_all_data TO postgresdluser;`
  - postgresdockerlocal=# `GRANT ALL PRIVILEGES ON DATABASE "fapidb" to postgresdluser;`
  - postgresdockerlocal=# `GRANT USAGE ON SCHEMA public TO postgresdluser;`
  - postgresdockerlocal=# `GRANT ALL ON SCHEMA public TO postgresdluser;`
  - postgresdockerlocal=# `GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO postgresdluser;`

- Kill the process pid: `kill -9 <pid_of_process>`. 

---------

Others:

- Setup working condition: Works.
- Note some of the issues faced setting up project:  
  - Timestamp parsing issues, so had to add this line: `json_encoders = {datetime: lambda v: v.isoformat(timespec='seconds') if isinstance(v, datetime) else v ... etc}`
  - CORS issue faced in Nginx when responding back from backend to frontend. 
  - Schema validation errors (Pydantic) in the API response from the weather app. 
  - Config.yml format working for KrakenD setup, and not config.json - have to debug further. 
  - During testing, changes were not reflecting when building/starting the microservices - so had to cleanup the cache, volumes, etc in Podman/Docker and repull it. 
  - Had issues running up debezium/kafka services, because of platform architecture issues. Later changed the base image. 
    - If you need to specify the architecture (like linux/amd64), you can build the images using the --platform flag. However, Podman does not directly support the --platform flag with podman-compose. Instead, you can build your images separately using podman build with the --platform option. Docker does, but still, have to see if it would've solved the issue - rather I used another base image.
    - Also, tried instead of running images directly in compose file, created a dockerfile with base OS ubuntu and running the images on top of it, still it gave some other kind of issues. 
- Useful link: [Json loads method link](https://stackoverflow.com/questions/58048879/what-is-the-difference-between-json-method-and-json-loads)
- To list topics in Kafka: `kafka-topics --list --bootstrap-server localhost:9092`
- To view all messages inside kafka topic: `kafka-console-consumer --bootstrap-server localhost:9092 --topic topic_a --from-beginning`
- More details about microservices in few projects I worked on earlier: 
  - https://github.com/surajvm1/LearningMicroservices
  - https://github.com/surajvm1/mDumpSWE
- Some other errors observed: 
    ```
    Error 1: 
    zookeeper container error: rosetta error: unhandled auxillary vector type 28
    debezium error: rosetta error: unhandled auxillary vector type 28
    kafka error: 
    java.lang.IllegalArgumentException: Unable to canonicalize address zookeeper/<unresolved>:2181 because it's not resolvable
            at org.apache.zookeeper.SaslServerPrincipal.getServerPrincipal(SaslServerPrincipal.java:78)
            at org.apache.zookeeper.SaslServerPrincipal.getServerPrincipal(SaslServerPrincipal.java:41)
            at org.apache.zookeeper.ClientCnxn$SendThread.startConnect(ClientCnxn.java:1157)
            at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1207)
    ERROR Timed out waiting for connection to Zookeeper server [zookeeper:2181]. (io.confluent.admin.utils.ClusterStatus)
    ERROR Unable to resolve address: zookeeper/<unresolved>:2181 (org.apache.zookeeper.client.StaticHostProvider)
    java.net.UnknownHostException: zookeeper
            at java.base/java.net.InetAddress$CachedAddresses.get(InetAddress.java:801)
            at java.base/java.net.InetAddress.getAllByName0(InetAddress.java:1533)
            at java.base/java.net.InetAddress.getAllByName(InetAddress.java:1385)
            at java.base/java.net.InetAddress.getAllByName(InetAddress.java:1306)
            at org.apache.zookeeper.client.StaticHostProvider$1.getAllByName(StaticHostProvider.java:88)
            at org.apache.zookeeper.client.StaticHostProvider.resolve(StaticHostProvider.java:141)
            at org.apache.zookeeper.client.StaticHostProvider.next(StaticHostProvider.java:368)
            at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1204)
    INFO Session: 0x0 closed (org.apache.zookeeper.ZooKeeper)
    INFO EventThread shut down for session: 0x0 (org.apache.zookeeper.ClientCnxn)
    Using log4j config /etc/kafka/log4j.properties
    
    Error 2: 
    kafka consumer error: Traceback (most recent call last):
      File "/kafka_consumer/consumer.py", line 33, in <module>
        consume_topic_a()
      File "/kafka_consumer/consumer.py", line 5, in consume_topic_a
        consumer = KafkaConsumer(
      File "/usr/local/lib/python3.9/site-packages/kafka/consumer/group.py", line 356, in __init__
        self._client = KafkaClient(metrics=self._metrics, **self.config)
      File "/usr/local/lib/python3.9/site-packages/kafka/client_async.py", line 244, in __init__
        self.config['api_version'] = self.check_version(timeout=check_timeout)
      File "/usr/local/lib/python3.9/site-packages/kafka/client_async.py", line 900, in check_version
        raise Errors.NoBrokersAvailable()
    kafka.errors.NoBrokersAvailable: NoBrokersAvailable
  
    Error 3: 
    When trying to run podman/docker compose up, there seems some cyclic dependency in containers yielding: 
    Unable to start container 7d894592e938ccf2c05115ff41e325cc1970fcce198b6fa04479bf99e1db8f36: preparing container 7d894592e938ccf2c05115ff41e325cc1970fcce198b6fa04479bf99e1db8f36 for attach: generating dependency graph for container 7d894592e938ccf2c05115ff41e325cc1970fcce198b6fa04479bf99e1db8f36: container 8bcd4866f6d4899e50f445ed111d9df1dce063ece75c13c2c523587e423921e5 depends on container b369eb05745b14a5e57f107f55789905b78788f2ec60cda8dd6dc2564fb4caee not found in input list: no such container
    Tried adding timeout when container boots up, and health check also, but no help, like eg:
    kafka:
      image: confluentinc/cp-kafka:latest
      container_name: kafka
      depends_on:
        - zookeeper
      environment:
        KAFKA_BROKER_ID: 1
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ports:
        - "9092:9092"
      healthcheck:
        test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
        interval: 10s
        timeout: 5s
        retries: 5
    
    Error 4: 
    urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='external_service_a', port=9900): Max retries exceeded with url: /externalApi/getWeather/delhi (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0xffff94ecda30>: Failed to establish a new connection: [Errno 111] Connection refused'))

  
    ```

---------

